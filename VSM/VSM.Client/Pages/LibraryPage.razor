@page "/library"
@rendermode InteractiveAuto
@using Microsoft.FluentUI.AspNetCore.Components
@using System.Linq.Expressions
@using VSM.Client.Datamodel
@inject NavigationManager Navigation

<PageTitle>Library</PageTitle>

<FluentStack Orientation="Orientation.Vertical">
    @if (Library.Instance.UsersRootFolders.Count == 0)
    {
        <div style="display:flex">
            <p>Login to access your simulations:</p>

            <FluentTextField @bind-Value="@user_name" Placeholder="your initials"></FluentTextField>
            <FluentButton OnClick="@OnLoginClicked" Appearance="Appearance.Accent">Login</FluentButton>
        </div>

        if (has_loaded_rootFolders)
        {
            <div style="display:flex">
                <p>Load of root folders has failed or you are not owner or approver of any root folder! </p>
            </div>
        }
    }
    else
    {
        <FluentStack Orientation="Orientation.Vertical">
            <p>User: @Library.Instance.User</p>
            <hr />
            <div class="grid">
                <FluentDataGrid Items="@Library.Instance.UsersRootFolders.AsQueryable()" TGridItem="RootFolder"
                    OnRowClick="OnSelectRootFolder" ShowHover="true" DisplayMode="DataGridDisplayMode.Table"
                    GenerateHeader="@GenerateHeaderOption.Sticky" MultiLine="true">

                    <PropertyColumn Title="Secure folder" Property="@(folder => folder.Root_path)" Width="400px" />

                    <TemplateColumn Title="Owners" Width="300px">
                        <ChildContent Context="folder">
                            @string.Join(", ", folder.AllInitials)
                        </ChildContent>
                    </TemplateColumn>

                    <TemplateColumn Title="Retention period" Width="180px">
                        <ChildContent Context="folder">
                            @($"{cycleTimeConverter.DaysToName(folder.CleanupConfiguration.Lead_time)}")
                        </ChildContent>
                    </TemplateColumn>

                    <TemplateColumn Title="Cleanup frequency" Width="190px">
                        <ChildContent Context="folder">
                            @($"{frequencyConverter.DaysToName(folder.CleanupConfiguration.Frequency)}")
                        </ChildContent>
                    </TemplateColumn>

                    <TemplateColumn Title="Retentions" Width="300px">
                        <ChildContent Context="folder">
                            @if (folder.CleanupConfiguration.IsValid)
                            {
                                <FluentButton Appearance="Appearance.Accent" @onclick="@(() => Go2retention(folder))">Go to
                                    retentions</FluentButton>
                            }
                            else
                            {
                                <FluentButton Appearance="Appearance.Neutral" Disabled="true">-</FluentButton>
                            }
                        </ChildContent>
                    </TemplateColumn>
                </FluentDataGrid>
            </div>
        </FluentStack>
        <FluentStack Orientation="Orientation.Vertical">
            <hr />
            @if (Library.Instance.SelectedRootFolder != null)
            {
                <div style="display:flex"><span style="width: 170px; display: inline-block;">Secure folder:</span>
                    @Library.Instance.SelectedRootFolder.Root_path
                </div>
                string ownerstring = string.Join(", ", Library.Instance.SelectedRootFolder.AllInitials);
                <div style="display:flex"><span style="width: 170px; display: inline-block;">Owners & approvers:</span>
                    @ownerstring
                </div>
                <div style="display:flex"><span style="width: 170px; display: inline-block;">Retention period:</span>
                    <FluentCombobox Autofocus="true" Items="@cycleTimeConverter?.Names()" @bind-Value="@cycle_time_name"
                        @bind-Value:after="UpdateCleanUpConfiguration" Height="300px" Position="SelectPosition.Above" Immediate
                        ImmediateDelay="100" />
                    <span style="width: 320px; display: inline-block;"> - days needed to analyse a simulation</span>
                </div>
                <div style="display:flex"><span style="width: 170px; display: inline-block;">Cleanup frequency</span>
                    <FluentCombobox Autofocus="true" Items="@frequencyConverter?.Names()" @bind-Value="@frequency_name"
                        @bind-Value:after="UpdateCleanUpConfiguration" Height="300px" Position="SelectPosition.Above" Immediate
                        ImmediateDelay="100" />
                    <span style="width: 260px; display: inline-block;"> Days between cleanups</span>
                </div>
            }
        </FluentStack>
    }
</FluentStack>