@page "/retention"
@rendermode InteractiveAuto
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.Components
@using System.Globalization;
@using System.ComponentModel.DataAnnotations
@using VSM.Client.Datamodel
@using VSM.Client.SharedAPI
@inject NavigationManager Navigation
@inject NavigationDataService NavService
@inject API Api

<h3>Retention settings</h3>

<FluentStack Orientation="Orientation.Vertical">
    @if (isLoading)
    {
        <div
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; text-align: center;">
            <FluentProgressRing Width="128px"></FluentProgressRing>
            <div style="margin-top: 16px; font-size: 16px;">
                Loading folders...
            </div>
        </div>
    }
    else if (visibleTable.VisibleRootNode == null || visibleTable.VisibleRows.Count == 0)
    {
        <div style="display:flex">
            <p>To work with retention you must first select a rootfolder on the Library page!</p>
        </div>
    }
    else if(rootFolder!=null)
    {
        @*<FluentBodyContent>*@
        <FluentStack Orientation="Orientation.Vertical"> 
            <hr />
            <div class="grid">
                <div  style="display: table; table-layout: fixed; width: 100%;">
                    <FluentDataGrid Items="@visibleTable.VisibleRows.AsQueryable()" TGridItem="ViewNode" Virtualize="true" ItemSize="25"
                        ShowHover="true" DisplayMode="DataGridDisplayMode.Table" GenerateHeader="@GenerateHeaderOption.Sticky" Style="min-width: max-content;">

                        <TemplateColumn TGridItem="ViewNode" Title="Folders" Width="400px">
                            <ChildContent Context="item">
                                <div style="paddingx-left:@(item.Level * 18)px; display:flex; align-items:center;">
                                    @if (!item.IsLeaf && visibleTable.VisibleRootNode != null)
                                    {
                                        <button class="e-flat" @onclick="() => ToggleExpand(visibleTable.VisibleRootNode, item)"
                                            style="width:1.5em; height:1.5em; padding:0; display:inline-flex; align-items:center; justify-content:center;">
                                            @(item.IsExpanded ? "▾" : "▸")
                                        </button>
                                        <span style="margin-left:8px;">@item.Name</span>
                                    }
                                    else
                                    {
                                        @* placeholder so leaf rows align with nodes that have a toggle button *@
                                        <span style="display:inline-block; width:1.5em;"></span>
                                        <span style="margin-left:8px;">@item.Name</span>
                                    }
                                </div>
                            </ChildContent>
                        </TemplateColumn>
                    
                        @foreach (RetentionTypeDTO key in rootFolder.RetentionTypes.AllRetentions)
                        {                
                            //Width="100px"
                            int unicodeChars = new StringInfo(key.Name).LengthInTextElements;
                            string header_with = $"{unicodeChars * 15}px";
                            <TemplateColumn TGridItem="ViewNode" 
                                Title="@key.Name" 
                                Width=@header_with
                                >
                                <ChildContent Context="item">
                                    @{
                                        RetentionCell cell = new RetentionCell(item.Data, key);
                                        
                                        string buttonClass = "e-flat";
                                        if( cell == selected_cell ){
                                            buttonClass = cell.CanChangeRetention() ? "e-flat-selected" : "e-flat-selected-grey";
                                        } else if( target_retention_cell == cell ){
                                            buttonClass = "e-flat-target";
                                        }
                                        <button class="@buttonClass" @onclick="() => OnCellClick(cell)">
                                            @if (item.Data.AttributeDict.TryGetValue(key.Id, out var val))
                                            {
                                                @val
                                            } else
                                            {
                                                <span style="color:lightgrey;">----</span>
                                            }
                                        </button>
                                    }
                                </ChildContent>
                            </TemplateColumn>
                        }     
                    </FluentDataGrid>
    ¨           </div>
            </div>
        </FluentStack>    
        <FluentStack Orientation="Orientation.Vertical"> 
            <hr />
            <h3> Review and change retention</h3>
            @{
                RetentionCell? cell = target_retention_cell ?? selected_cell;
                @if (cell != null)
                {
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <span>Folder: </span>
                        <span>@cell.Node.FullPath</span>
                    </div>
                }
                @if (isProcessing)
                {
                    <div style="margin-top: 20px;">
                        <FluentProgress Text="Updating retention settings..." />
                    </div>
                }
            }
            <FluentStack Orientation="Orientation.Horizontal" Style="margin-top: 20px)">
                <FluentStack Orientation="Orientation.Vertical" Width="400px" >
                @{                 
                    RetentionCell? cell = target_retention_cell ?? selected_cell;
                    @if (cell != null)
                    {
                        <div>
                            @if (cell == target_retention_cell)
                            {
                                <span>New retention:</span>
                                <span>@cell.retention.Name</span>
                            }
                            else
                            {
                                <span>Retention:</span>
                                <span>@cell.retention.Name</span>
                            }
                        </div>

                        @if ( selected_cell != null && selected_cell.CanChangeRetention() )
                        {
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <FluentSelect Label="Change retention:"
                                    Items="@rootFolder.RetentionTypes.TargetRetentions" 
                                    TOption="RetentionTypeDTO"
                                    OptionText="@(r => r.Name)" 
                                    OptionValue="@(r => r.Id.ToString())"
                                    @bind-SelectedOption="@retentionCallback" 
                                    Height="300px" Position="SelectPosition.Above"
                                    ImmediateDelay="100"
                                        Autofocus="true"
                                    Disabled="@isProcessing" />
                            </div>
                        }
                    }
                }
                </FluentStack>
                                        

                <FluentStack Orientation="Orientation.Vertical">
                    <div class="grid">
                        @{
                            RetentionCell? cell = target_retention_cell ?? selected_cell;
                            @if (cell != null && cell.retention.Id == rootFolder.RetentionTypes.PathRetentionType.Id)
                            {
                                <span>List of Path retentions: </span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <FluentDataGrid Items="@rootFolder.PathProtections.AsQueryable()" 
                                                    TGridItem="PathProtectionDTO" 
                                                    ItemSize="25"
                                                    ShowHover="true" 
                                                    DisplayMode="DataGridDisplayMode.Table" 
                                                    GenerateHeader="@GenerateHeaderOption.Sticky"
                                                    MultiLine="true">
                                        <TemplateColumn Title="Protected path" Width="1800px">
                                            <ChildContent Context="pathprotection">
                                                @{
                                                    string buttonClass = "e-flat";
                                                    if( selected_cell != null && selected_cell.Node.Id == pathprotection.FolderId )
                                                        buttonClass = "e-flat-selected";

                                                    <button class="@buttonClass" @onclick="() => SelectPathRetention(pathprotection)">
                                                            @pathprotection.Path
                                                    </button>
                                                }
                                            </ChildContent>
                                        </TemplateColumn>
                                    </FluentDataGrid>
                                </div>
                                <FluentButton Appearance="Appearance.Accent" @onclick="@(() => AddPathRetention(cell))">Add path retention
                                </FluentButton>
                            }
                        }
                    </div>
                </FluentStack>
                
            </FluentStack>
        </FluentStack>
    }
</FluentStack>